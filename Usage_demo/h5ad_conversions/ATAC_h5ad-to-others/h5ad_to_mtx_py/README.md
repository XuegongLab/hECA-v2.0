# H5AD to MTX Conversion Tool

This tool converts ATAC-seq data from H5AD format (AnnData) to MTX format (Matrix Market Exchange), creating sparse matrix files and metadata files for universal compatibility across different analysis platforms.

## Overview

The Matrix Market Exchange (MTX) format is a standard sparse matrix format that provides excellent compatibility across multiple programming languages and analysis platforms. This converter transforms single-cell ATAC-seq data from Python's AnnData format (.h5ad files) into MTX format, enabling seamless data sharing and analysis across different computational environments.

## Features

- **Universal compatibility**: MTX format is supported by Python, R, Julia, MATLAB, and other platforms
- **Memory efficient**: Preserves sparse matrix format to minimize storage and memory usage
- **Complete metadata preservation**: Exports all cell and feature metadata as tab-separated files
- **Cross-platform loading scripts**: Generates Python and R scripts for easy data import
- **Data validation**: Comprehensive validation of ATAC-seq data format and quality
- **Dimensionality reduction export**: Preserves PCA, UMAP, t-SNE, and other embeddings
- **Detailed documentation**: Automatic generation of conversion summary and usage instructions

## Output Files

The conversion process generates the following files:

- `matrix.mtx`: Sparse count matrix in Matrix Market format (cells × features)
- `features.tsv`: Feature names and types (tab-separated, three columns: ID, name, type)
- `barcodes.tsv`: Cell barcodes/identifiers (tab-separated, one column)
- `cell_metadata.tsv`: Cell annotations and metadata (tab-separated, if available)
- `feature_metadata.tsv`: Feature annotations and metadata (tab-separated, if available)
- `*_embeddings.tsv`: Dimensionality reduction results (tab-separated)
- `load_mtx_data.py`: Python script for loading the converted data
- `load_mtx_data.R`: R script for loading the converted data
- `conversion_summary.md`: Detailed summary of the conversion process

## Usage

### Command Line Interface

```bash
# Basic conversion
python convert.py input.h5ad

# Specify output directory
python convert.py input.h5ad -o mtx_data

# Enable verbose logging
python convert.py input.h5ad --verbose
```

### Loading Data After Conversion

#### Python
```python
# Using the generated loading script
exec(open('load_mtx_data.py').read())
adata = load_mtx_data()

# Manual loading
from scipy import io
import pandas as pd
import scanpy as sc

# Read matrix and metadata
matrix = io.mmread('matrix.mtx').tocsr()
features = pd.read_csv('features.tsv', sep='\t', header=None)
barcodes = pd.read_csv('barcodes.tsv', sep='\t', header=None)

# Create AnnData object
adata = sc.AnnData(X=matrix)
adata.var_names = features[0].values
adata.obs_names = barcodes[0].values
```

#### R
```r
# Using the generated loading script
source("load_mtx_data.R")
data <- load_mtx_data()

# Manual loading
library(Matrix)
counts <- readMM("matrix.mtx")
features <- read.delim("features.tsv", header=FALSE)
barcodes <- read.delim("barcodes.tsv", header=FALSE)

# Set names
rownames(counts) <- barcodes[,1]
colnames(counts) <- features[,1]
```

## Data Requirements

### Input Format
- **File type**: H5AD (AnnData format)
- **Data type**: Single-cell count data (preferably sparse)
- **Feature names**: Any format (genomic coordinates recommended for ATAC-seq)
- **Count data**: Non-negative values (integer or float)

### Expected Structure
```
AnnData object with:
- .X: Count matrix (cells × features)
- .obs: Cell metadata (optional)
- .var: Feature metadata (optional)
- .obsm: Dimensionality reductions (optional)
```

## Platform Compatibility

The MTX format generated by this tool is compatible with:

### Python Ecosystem
- **scanpy**: Single-cell analysis
- **scipy**: Scientific computing
- **pandas**: Data manipulation
- **AnnData**: Annotated data matrices

### R Ecosystem
- **Matrix**: Sparse matrix operations
- **Seurat**: Single-cell analysis
- **SingleCellExperiment**: Bioconductor container
- **Monocle**: Trajectory analysis

### Other Platforms
- **Julia**: MatrixMarket.jl package
- **MATLAB**: Matrix Market I/O functions
- **C/C++**: Various sparse matrix libraries

## Installation Requirements

See `requirements.txt` for Python dependencies. The tool requires:

- Python 3.7+
- scanpy for H5AD file reading
- pandas for data manipulation
- scipy for sparse matrix operations
- numpy for numerical operations

## Validation and Quality Control

The tool performs several validation checks:

1. **File existence and format validation**
2. **Feature name format checking** (genomic coordinates recommended)
3. **Data range validation** (checks for negative values)
4. **Sparsity analysis and reporting**
5. **Matrix format verification**

## Performance and Memory

### Advantages of MTX Format
- **Sparse storage**: Only non-zero values are stored
- **Cross-platform**: Standard format recognized by multiple tools
- **Streaming**: Can be read/written without loading entire matrix
- **Compression**: Can be easily compressed for storage

### Performance Notes
- Conversion time scales linearly with non-zero elements
- Memory usage is proportional to sparse matrix size
- Loading scripts optimize for memory efficiency
- Large datasets benefit significantly from sparse format

## Troubleshooting

### Common Issues

**File format errors**:
- Verify input file has .h5ad extension
- Check file permissions and accessibility

**Memory issues**:
- MTX format is memory-efficient for sparse data
- Dense matrices are automatically converted to sparse

**Loading errors**:
- Ensure required packages are installed (scipy, Matrix)
- Check that all output files are present

**Metadata issues**:
- Missing metadata files are handled gracefully
- Check file paths in loading scripts

## Example Workflows

### Data Analysis Pipeline
```bash
# Convert to MTX format
python convert.py atac_data.h5ad -o analysis_data

# Analysis in Python
python -c "
exec(open('analysis_data/load_mtx_data.py').read())
adata = load_mtx_data('analysis_data')
import scanpy as sc
sc.pp.filter_cells(adata, min_genes=200)
sc.pp.filter_genes(adata, min_cells=3)
"

# Analysis in R
R -e "
source('analysis_data/load_mtx_data.R')
data <- load_mtx_data('analysis_data')
library(Seurat)
seurat_obj <- CreateSeuratObject(counts = t(data$counts))
"
```

### Data Sharing
```bash
# Convert for sharing
python convert.py dataset.h5ad -o shared_data

# Compress for transfer
tar -czf shared_data.tar.gz shared_data/

# Recipients can use provided loading scripts
# No need for format-specific software
```

## File Format Specifications

### MTX Format
- Header: `%%MatrixMarket matrix coordinate integer general`
- Dimensions: `rows columns non_zeros`
- Data: `row_index column_index value` (1-indexed)

### TSV Format
- Tab-separated values
- UTF-8 encoding
- First column typically contains identifiers
- Header row included for metadata files

## Notes

- Matrix orientation follows standard convention (cells × features)
- Sparse matrix format is preserved throughout the process
- All metadata is exported in human-readable tab-separated format
- Loading scripts handle missing files gracefully
- Conversion summary provides detailed statistics and usage instructions